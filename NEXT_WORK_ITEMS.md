# 下一步工作清单（不重构 Stream 架构）

## 📊 当前状态总结

### ✅ 已完成的核心功能
- ✅ SOCKS5 客户端代理（已实现并工作正常）
- ✅ SOCKS5 服务器代理转发（已实现并工作正常）
- ✅ 双向数据转发（已解决锁竞争问题）
- ✅ TLS 连接和认证
- ✅ 基础错误处理和日志
- ✅ Settings/PaddingScheme 动态更新
- ✅ SYNACK 错误处理
- ✅ Session seq 字段暴露
- ✅ 集成测试套件（7个测试）
- ✅ 性能基准测试框架
- ✅ 代码质量优化（日志级别、代码清理）

### ✅ 当前系统状态
- **功能完整性**: ~95%
- **稳定性**: ✅ 稳定（多次请求成功，测试通过）
- **性能**: ✅ 满足基本需求（基准测试已建立）
- **代码质量**: ✅ 优秀（日志优化、代码清理完成）
- **测试覆盖**: ✅ 基础覆盖完成（集成测试、性能基准）

---

## 🎯 下一步工作分类

### 一、代码质量与维护（P0 - 高优先级）

#### 1.1 清理和优化日志级别 🔧
**当前问题**: 
- 太多 `INFO` 级别日志，生产环境可能过于冗余
- 一些关键路径的日志应该降级

**工作内容**:
- [ ] 审查所有 `tracing::info!` 调用
- [ ] 将调试类日志改为 `tracing::debug!` 或 `tracing::trace!`
- [ ] 保留关键业务日志为 `INFO`（如连接建立、错误）
- [ ] 添加日志级别配置支持（环境变量或命令行参数）

**预计时间**: 1-2 小时

**文件**:
- `src/server/handler.rs` - 大量 INFO 日志
- `src/client/socks5.rs` - 大量 INFO 日志
- `src/session/stream.rs` - 部分 INFO 日志
- `src/session/session.rs` - 部分 INFO 日志

---

#### 1.2 移除未使用的代码和注释 📝
**当前问题**:
- 存在未使用的函数（如 `proxy_tcp_connection`）
- 有大量的临时调试注释
- 超时相关的代码注释可以简化

**工作内容**:
- [ ] 移除 `proxy_tcp_connection` 函数（已被 `proxy_tcp_connection_with_synack` 替代）
- [ ] 清理临时调试注释
- [ ] 简化超时机制相关代码的注释
- [ ] 使用 `cargo clippy` 检查未使用的代码

**预计时间**: 1 小时

**文件**:
- `src/server/handler.rs` - 未使用的函数和注释

---

#### 1.3 完成 TODO 项 ✏️
**发现的 TODO**:
```rust
// src/session/session.rs:291
// TODO: Notify stream about the error

// src/session/session.rs:388
// TODO: Log and close session
```

**工作内容**:
- [ ] 实现 SYNACK 错误通知机制
- [ ] 完善 Alert 帧的错误处理和日志
- [ ] 确保错误能正确传播到调用者

**预计时间**: 1-2 小时

---

### 二、功能完善（P1 - 中优先级）

#### 2.1 Settings 和 PaddingScheme 动态更新 ⚙️
**当前状态**: 
- Settings 帧已接收并解析
- 但未完全实现动态更新 PaddingScheme

**工作内容**:
- [ ] 完善 `Command::Settings` 处理
  - 解析 `padding-md5` 参数
  - 在服务器端验证并发送 `ServerSettings`
  - 在客户端接收并更新本地 `PaddingFactory`
- [ ] 实现 `Command::UpdatePaddingScheme` 处理
- [ ] 添加单元测试

**预计时间**: 2-3 小时

**参考**: Go 版本的 `session.go` 中的 Settings 处理

---

#### 2.2 SYNACK 错误处理完善 🔍
**当前状态**:
- SYNACK 已实现基本功能
- 但错误信息（SYNACK 中携带错误）未完全处理

**工作内容**:
- [ ] 在客户端读取 SYNACK 中的错误信息
- [ ] 如果 SYNACK 包含错误，将错误传播到 Stream
- [ ] 在客户端 SOCKS5 handler 中显示有意义的错误消息
- [ ] 添加错误处理的单元测试

**预计时间**: 1-2 小时

**文件**:
- `src/session/session.rs` - handle_frame 中 SYNACK 处理
- `src/client/client.rs` - create_proxy_stream 中错误处理

---

#### 2.3 Session seq 字段暴露 📊
**当前状态**:
- Session 内部有 `seq` 字段
- 但 SessionPool 可能需要访问它

**工作内容**:
- [ ] 添加 `Session::seq()` 公开方法
- [ ] 确保 seq 字段用于会话池排序
- [ ] 验证会话复用池的逻辑正确性

**预计时间**: 30 分钟 - 1 小时

**文件**:
- `src/session/session.rs` - 添加公开方法
- `src/client/session_pool.rs` - 使用 seq 排序

---

### 三、测试与验证（P2 - 中高优先级）

#### 3.1 集成测试套件 🧪
**当前状态**:
- 有基础的单元测试
- 缺少端到端集成测试

**工作内容**:
- [ ] 创建 `tests/integration/` 目录
- [ ] 实现端到端测试：
  - 客户端-服务器连接测试
  - SOCKS5 代理 HTTP 请求测试
  - 多个并发连接测试
  - 错误场景测试（连接失败、认证失败等）
- [ ] 使用 `testcontainers` 或模拟服务器进行测试
- [ ] 添加性能基准测试

**预计时间**: 3-4 小时

**文件结构**:
```
tests/
├── integration/
│   ├── mod.rs
│   ├── basic_proxy.rs      # 基本代理功能测试
│   ├── concurrent.rs        # 并发连接测试
│   ├── error_handling.rs    # 错误处理测试
│   └── performance.rs       # 性能基准测试
```

---

#### 3.2 压力测试和性能基准 📈
**当前状态**:
- 基本功能测试通过
- 缺少性能和压力测试

**工作内容**:
- [ ] 使用 `criterion` 添加性能基准测试
- [ ] 测试不同并发数下的性能（10, 100, 1000 连接）
- [ ] 测试大文件传输性能
- [ ] 测试长时间运行稳定性（如 1 小时连续运行）
- [ ] 对比 Go 版本的性能（如果可能）

**预计时间**: 2-3 小时

**工具**:
- `criterion` - Rust 性能测试框架
- `wrk` 或 `ab` - HTTP 压力测试工具

---

#### 3.3 内存泄漏检查 🔍
**工作内容**:
- [ ] 使用 `valgrind` 或 `cargo-valgrind` 检查内存泄漏
- [ ] 使用 `tokio-console` 检查任务泄漏
- [ ] 长时间运行测试，监控内存使用
- [ ] 检查 `Arc` 循环引用问题

**预计时间**: 1-2 小时

---

### 四、功能扩展（P3 - 低优先级）

#### 4.1 UDP over TCP (UoT) 支持 🌐
**当前状态**: 
- 只有 TCP 代理
- Go 版本支持 UoT

**工作内容**:
- [ ] 参考 Go 版本的 `proxyOutboundUoT`
- [ ] 实现 UoT 协议解析
- [ ] 实现 UDP 数据包封装/解封装
- [ ] 添加 UoT 相关的 Frame 命令（如果需要）
- [ ] 添加测试

**预计时间**: 4-6 小时

**参考**:
- `cmd/server/outbound_tcp.go` - `proxyOutboundUoT` 函数
- UoT 协议规范

---

#### 4.2 HTTP 代理支持 🌍
**当前状态**:
- 只有 SOCKS5 代理
- HTTP CONNECT 代理未实现

**工作内容**:
- [ ] 实现 HTTP CONNECT 方法解析
- [ ] 处理 HTTP 代理请求格式
- [ ] 返回 HTTP 响应
- [ ] 在 `bin/client.rs` 中添加 HTTP 代理模式选项

**预计时间**: 2-3 小时

---

#### 4.3 心跳机制 (HeartRequest/HeartResponse) 💓
**工作内容**:
- [ ] 实现 HeartRequest/HeartResponse Frame
- [ ] 在 Session 中添加心跳发送逻辑
- [ ] 处理超时未收到心跳的情况
- [ ] 配置心跳间隔

**预计时间**: 1-2 小时

**参考**: Go 版本的心跳实现

---

### 五、文档和用户体验（P2 - 中优先级）

#### 5.1 API 文档生成 📚
**工作内容**:
- [ ] 确保所有公共 API 都有文档注释
- [ ] 使用 `cargo doc --open` 生成并检查文档
- [ ] 添加使用示例到文档注释中
- [ ] 添加架构图（使用 mermaid 或其他工具）

**预计时间**: 1-2 小时

**命令**:
```bash
cargo doc --open --no-deps
```

---

#### 5.2 README 更新 📖
**工作内容**:
- [ ] 更新 README 反映当前完成状态
- [ ] 添加快速开始指南
- [ ] 添加配置选项说明
- [ ] 添加故障排查指南链接
- [ ] 添加性能数据（如果可用）

**预计时间**: 1 小时

---

#### 5.3 命令行参数完善 ⚙️
**当前状态**:
- 基本参数已实现
- 可能缺少一些有用的选项

**工作内容**:
- [ ] 添加日志级别参数（`--log-level`）
- [ ] 添加配置文件支持（`--config`）
- [ ] 添加 `--version` 和 `--help` 完善
- [ ] 添加性能相关选项（如缓冲大小）

**预计时间**: 1-2 小时

**文件**:
- `src/bin/client.rs`
- `src/bin/server.rs`

---

### 六、性能优化（P3 - 可选）

#### 6.1 减少日志开销 📉
**当前状态**:
- 大量日志可能影响性能

**工作内容**:
- [ ] 使用条件编译减少 release 模式下的日志
- [ ] 考虑使用 `tracing` 的 `enabled!` 宏
- [ ] 性能测试对比有无日志的差异

**预计时间**: 1-2 小时

---

#### 6.2 缓冲优化 📦
**工作内容**:
- [ ] 优化 Stream buffer 大小
- [ ] 测试不同 buffer 大小的性能影响
- [ ] 考虑使用对象池复用 buffer

**预计时间**: 1-2 小时

---

#### 6.3 减少内存分配 🔄
**工作内容**:
- [ ] 使用 `bytes::Bytes` 池化
- [ ] 减少不必要的 `Vec` 分配
- [ ] 使用 `smallvec` 或类似优化小数组

**预计时间**: 2-3 小时

---

## 📅 推荐实施顺序

### 第一阶段：代码质量（1-2 天）
1. ✅ **清理日志级别** (1-2h)
2. ✅ **移除未使用代码** (1h)
3. ✅ **完成 TODO 项** (1-2h)

**目标**: 代码更干净，生产环境可用

---

### 第二阶段：功能完善（2-3 天）
4. ✅ **Settings/PaddingScheme** (2-3h)
5. ✅ **SYNACK 错误处理** (1-2h)
6. ✅ **Session seq** (30min-1h)

**目标**: 协议功能完整，错误处理完善

---

### 第三阶段：测试与验证（2-3 天）
7. ✅ **集成测试** (3-4h)
8. ✅ **性能基准** (2-3h)
9. ✅ **内存泄漏检查** (1-2h)

**目标**: 确保系统稳定可靠

---

### 第四阶段：文档与用户体验（1 天）
10. ✅ **API 文档** (1-2h)
11. ✅ **README 更新** (1h)
12. ✅ **命令行参数** (1-2h)

**目标**: 提升用户体验

---

### 第五阶段：功能扩展（按需）
13. ⚙️ **UoT 支持** (4-6h) - 如果需要
14. ⚙️ **HTTP 代理** (2-3h) - 如果需要
15. ⚙️ **心跳机制** (1-2h) - 如果需要

**目标**: 功能对齐 Go 版本

---

### 第六阶段：性能优化（按需）
16. ⚙️ **日志优化** (1-2h)
17. ⚙️ **缓冲优化** (1-2h)
18. ⚙️ **内存优化** (2-3h)

**目标**: 性能提升

---

## 🎯 优先级总结

### 立即开始（本周）
- [x] 清理日志级别
- [x] 移除未使用代码
- [x] 完成 TODO 项

### 短期目标（1-2 周）
- [ ] Settings/PaddingScheme 完善
- [ ] 集成测试套件
- [ ] API 文档生成

### 中期目标（1 个月）
- [ ] UoT 支持（如果需要）
- [ ] 性能优化（如果需要）

### 长期目标（按需）
- [ ] HTTP 代理
- [ ] 心跳机制
- [ ] 其他扩展功能

---

## 📊 工作量估算

**最小工作量**（代码质量 + 基础功能）:
- 3-4 小时（清理和 TODO）
- **总计**: 约 0.5 天

**推荐工作量**（代码质量 + 功能完善 + 测试）:
- 代码质量: 3-4 小时
- 功能完善: 4-6 小时
- 测试: 6-9 小时
- **总计**: 约 2-3 天

**完整工作量**（包含所有扩展功能）:
- 基础工作: 13-19 小时
- 扩展功能: 7-11 小时
- **总计**: 约 2.5-3.5 天

---

## ✅ 检查清单

### 代码质量
- [ ] 日志级别优化完成
- [ ] 未使用代码已移除
- [ ] 所有 TODO 已处理
- [ ] `cargo clippy` 无警告
- [ ] `cargo fmt` 格式化完成

### 功能完整性
- [ ] Settings 处理完善
- [ ] SYNACK 错误处理完善
- [ ] Session seq 可用
- [ ] 所有协议命令已实现

### 测试覆盖
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 性能测试完成
- [ ] 无内存泄漏

### 文档
- [ ] API 文档完整
- [ ] README 更新
- [ ] 使用示例完善

---

**最后更新**: 2025-11-02
**当前状态**: 系统工作正常，可开始优化和完善工作

