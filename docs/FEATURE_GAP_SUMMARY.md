# 🎯 功能差距速查表

**版本**: Rust v0.2.0 vs Go v0.0.10+  
**更新日期**: 2025-11-03

---

## 快速概览

| 类别 | Rust 完成度 | Go 完成度 | 差距 |
|------|------------|-----------|------|
| **基础协议** | 95% | 100% | -5% |
| **协议 v2** | 70% | 75% | -5% |
| **会话管理** | 85% | 95% | -10% |
| **代理功能** | 80% | 95% | -15% |
| **高级特性** | 0% | 5% | -5% |
| **性能** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐☆ | +20% |
| **总体** | **75%** | **85%** | **-10%** |

---

## 🔴 关键差距（需要实现）

### 1. 被动心跳响应 ⭐⭐⭐⭐⭐

| 项目 | Rust | Go | 差距 |
|------|------|----|------|
| **状态** | ❌ 未实现 | ✅ 已实现 | **-100%** |
| **影响** | 无法响应心跳 | 可响应心跳 | 功能缺失 |
| **工作量** | 1-2 天 | - | - |

**实现代码**:
```rust
// src/session/session.rs - handle_frame()
Command::HeartRequest => {
    let response = Frame::control(Command::HeartResponse, frame.stream_id);
    self.write_control_frame(response).await?;
}
Command::HeartResponse => {
    // 记录收到响应（未来用于主动检测）
}
```

### 2. UDP over TCP 支持 ⭐⭐⭐⭐☆

| 项目 | Rust | Go | 差距 |
|------|------|----|------|
| **状态** | ❌ 未实现 | ✅ 已实现 | **-100%** |
| **影响** | 不支持 UDP | 完整 UDP 代理 | 功能缺失 |
| **工作量** | 3-4 天 | - | - |

**检测代码**:
```rust
// src/server/handler.rs
let addr = read_socks_addr(&stream).await?;

if addr.domain == "sp.v2.udp-over-tcp.arpa" {
    // 实现 UDP over TCP
    proxy_udp_over_tcp(stream, session).await?;
} else {
    proxy_tcp_connection_with_synack(...).await?;
}
```

### 3. 会话池完善 ⭐⭐⭐☆☆

| 项目 | Rust | Go | 差距 |
|------|------|----|------|
| **Seq 跟踪** | ❌ | ✅ | -100% |
| **空闲时间精确管理** | ⚠️ | ✅ | -50% |
| **配置参数** | ⚠️ | ✅ | -60% |
| **工作量** | 2-3 天 | - | - |

**缺少的配置**:
```rust
// Go 有的配置参数
idleSessionCheckInterval: 30s   // Rust 未实现
idleSessionTimeout: 60s         // Rust 简化
minIdleSession: 1               // Rust 未实现
```

---

## 🟡 次要差距（可选实现）

### 4. 版本协商增强 ⭐⭐⭐☆☆

| 项目 | Rust | Go | 差距 |
|------|------|----|------|
| **协议降级** | ❌ | ⚠️ | -50% |
| **特性启用控制** | ❌ | ⚠️ | -50% |
| **工作量** | 2-3 天 | - | - |

**注**: Go 实现也不完善，两端都需改进

### 5. URI 格式支持 ⭐⭐☆☆☆

| 项目 | Rust | Go | 差距 |
|------|------|----|------|
| **URI 解析** | ❌ | ✅ | -100% |
| **影响** | 配置复杂 | 配置简单 | 体验差异 |
| **工作量** | 1 天 | - | - |

**示例**:
```
Go: anytls://password@server.com/?sni=real.com
Rust: --server server.com --password password --sni real.com
```

---

## 🟢 双方都缺失（可共同实现）

### 6. 主动心跳检测 ⭐⭐☆☆☆

| 项目 | Rust | Go | 状态 |
|------|------|----|------|
| **主动发送心跳** | ❌ | ❌ | 都未实现 |
| **超时检测** | ❌ | ❌ | 都未实现 |
| **自动恢复** | ❌ | ❌ | 都未实现 |

**Go 代码注释**: `"Active keepalive checking is not implemented yet"`

### 7. Fallback HTTP ⭐☆☆☆☆

| 项目 | Rust | Go | 状态 |
|------|------|----|------|
| **Fallback 逻辑** | ❌ | ❌ | 都未实现 |

**Go 代码**:
```go
func fallback(ctx context.Context, c net.Conn) {
    // 暂未实现
    logrus.Debugln("fallback:", c.RemoteAddr())
}
```

---

## 📊 详细对比表

### Command 支持

| Command | 功能 | Rust | Go | 差距 |
|---------|------|------|----|------|
| 0 Waste | Padding | ✅ | ✅ | 无 |
| 1 SYN | 打开流 | ✅ | ✅ | 无 |
| 2 PSH/Push | 数据传输 | ✅ | ✅ | 无 |
| 3 FIN | 关闭流 | ✅ | ✅ | 无 |
| 4 Settings | 客户端设置 | ✅ | ✅ | 无 |
| 5 Alert | 警告 | ✅ | ✅ | 无 |
| 6 UpdatePaddingScheme | 更新 Padding | ✅ | ✅ | 无 |
| 7 SYNACK | 确认打开 | ✅ | ✅ | 无 |
| 8 HeartRequest | 心跳请求 | ⚠️ 已定义 | ✅ 可响应 | **需实现** |
| 9 HeartResponse | 心跳响应 | ⚠️ 已定义 | ✅ 已接收 | **需实现** |
| 10 ServerSettings | 服务器设置 | ✅ | ✅ | 无 |

**说明**:
- Rust 已定义 Command 枚举，但未实现处理逻辑
- Go 可被动响应心跳，但无主动检测
- 两端都缺少完整的心跳机制

### 配置参数

#### 客户端

| 参数 | Rust | Go | 差距 |
|------|------|----|------|
| password | ✅ | ✅ | 无 |
| server | ✅ | ✅ | 无 |
| listen | ✅ | ✅ | 无 |
| sni | ✅ 命令行 | ✅ URI | 小 |
| insecure | ✅ 命令行 | ✅ URI | 小 |
| idleSessionCheckInterval | ❌ | ✅ 30s | **需添加** |
| idleSessionTimeout | ❌ | ✅ 60s | **需添加** |
| minIdleSession | ❌ | ✅ 1 | **需添加** |

#### 服务器

| 参数 | Rust | Go | 差距 |
|------|------|----|------|
| password | ✅ | ✅ | 无 |
| listen | ✅ | ✅ | 无 |
| cert | ✅ | ✅ | 无 |
| key | ✅ | ✅ | 无 |
| paddingScheme | ✅ | ✅ | 无 |
| fallback | ❌ | ⚠️ 未实现 | 小 |

### 代理功能

| 功能 | Rust | Go | 差距 |
|------|------|----|------|
| TCP 代理 | ✅ | ✅ | 无 |
| SOCKS5 客户端 | ✅ | ✅ | 无 |
| SocksAddr 格式 | ✅ | ✅ | 无 |
| UDP over TCP | ❌ | ✅ | **需实现** |
| HTTP 代理 | ❌ | ❌ | 无（都未实现） |

---

## 🚀 实施优先级

### 立即实施（v0.3.0）

| # | 功能 | 优先级 | 工作量 | ROI |
|---|------|--------|--------|-----|
| 1 | **被动心跳响应** | ⭐⭐⭐⭐⭐ | 1-2 天 | 极高 |
| 2 | **UDP over TCP** | ⭐⭐⭐⭐☆ | 3-4 天 | 高 |
| 3 | **会话池配置** | ⭐⭐⭐☆☆ | 2-3 天 | 中 |
| 4 | **SYNACK 超时** | ⭐⭐⭐☆☆ | 1-2 天 | 中 |

**总工作量**: 7-11 天

### 后续实施（v0.4.0+）

| # | 功能 | 优先级 | 工作量 | ROI |
|---|------|--------|--------|-----|
| 5 | **主动心跳检测** | ⭐⭐☆☆☆ | 3-4 天 | 中 |
| 6 | **Fallback HTTP** | ⭐⭐☆☆☆ | 2-3 天 | 中 |
| 7 | **URI 格式** | ⭐⭐☆☆☆ | 1 天 | 低 |
| 8 | **版本协商** | ⭐⭐☆☆☆ | 2-3 天 | 低 |

**总工作量**: 8-13 天

---

## ✅ 已实现功能（Rust = Go）

### 核心功能 ✅

- [x] Frame 编解码器
- [x] 7 个基础 Command (0-6)
- [x] SYNACK (Command 7)
- [x] ServerSettings (Command 10)
- [x] SHA256 认证
- [x] Padding 机制（完整）
- [x] PaddingScheme 解析
- [x] PaddingScheme 动态更新
- [x] Session 多路复用
- [x] Stream 读写
- [x] TCP 代理
- [x] SOCKS5 客户端
- [x] 会话复用（基础）
- [x] TLS 支持

### Rust 独有优势 ✅

- [x] **Stream 重构**: Reader/Writer 分离
- [x] **性能提升**: +40-60% 吞吐量
- [x] **无锁架构**: 消除锁竞争
- [x] **内存安全**: Rust 所有权系统
- [x] **类型安全**: 编译期保证

---

## ❌ 需要实现的功能

### 高优先级（v0.3.0）

1. **被动心跳响应** (1-2 天)
   - 处理 HeartRequest
   - 发送 HeartResponse
   
2. **UDP over TCP** (3-4 天)
   - sing-box 协议
   - UDP 代理逻辑

3. **会话池配置** (2-3 天)
   - idleSessionCheckInterval
   - idleSessionTimeout
   - minIdleSession

### 中优先级（v0.4.0）

4. **主动心跳检测** (3-4 天)
   - 定期发送心跳
   - 超时检测
   - 自动恢复

5. **Fallback HTTP** (2-3 天)
   - 实际 fallback 逻辑
   - HTTP 伪装

6. **URI 格式** (1 天)
   - URI 解析
   - 简化配置

---

## 🎯 v0.3.0 目标

### 目标

**追赶 Go 实现，达到 90% 功能完整度**

### 任务清单

- [ ] 实现被动心跳响应（1-2 天）
- [ ] 实现 UDP over TCP（3-4 天）
- [ ] 完善会话池管理（2-3 天）
- [ ] 增强 SYNACK 超时检测（1-2 天）
- [ ] 完善版本协商（2-3 天）

**预计工作量**: 9-14 天

### 预期成果

- ✅ 与 Go 实现功能对等
- ✅ 协议 v2 支持完整
- ✅ 所有基础功能完整
- ✅ 保持性能优势

---

## 📊 对比矩阵

### 功能完整性

```
基础协议:  Rust ████████████████████░ 95%   Go █████████████████████ 100%
协议 v2:   Rust ██████████████░░░░░░░ 70%   Go ███████████████░░░░░░ 75%
会话管理:  Rust █████████████████░░░░ 85%   Go ███████████████████░░ 95%
代理功能:  Rust ████████████████░░░░░ 80%   Go ███████████████████░░ 95%
高级特性:  Rust ░░░░░░░░░░░░░░░░░░░░░ 0%    Go █░░░░░░░░░░░░░░░░░░░░ 5%
性能:      Rust █████████████████████ 100%  Go ████████████████░░░░░ 80%
```

### 时间投入预估

```
v0.3.0 (追赶):     ████████████░░░░░░░░ 9-14 天
v0.4.0 (超越):     ████████░░░░░░░░░░░░ 8-13 天
v1.0.0 (稳定):     ████░░░░░░░░░░░░░░░░ 未估算
```

---

## 🎊 结论

### 现状

- ✅ Rust 实现已经完成 75% 功能
- ✅ 核心功能与 Go 基本一致
- ✅ 性能优于 Go（+40-60%）
- ⚠️ 缺少部分高级特性（心跳、UDP）

### 差距分析

**主要差距**:
1. 被动心跳响应（Go 有，Rust 无）
2. UDP over TCP（Go 有，Rust 无）
3. 会话池管理（Go 更完善）

**共同缺失**:
1. 主动心跳检测（两端都未实现）
2. Fallback HTTP（两端都未实现）

### 建议

1. **v0.3.0 重点**: 被动心跳 + UDP over TCP（2周）
2. **v0.4.0 重点**: 主动心跳 + Fallback（2周）
3. **持续优化**: 利用 Rust 性能优势

---

**更新日期**: 2025-11-03  
**详细文档**: [FEATURE_COMPARISON.md](./FEATURE_COMPARISON.md)

