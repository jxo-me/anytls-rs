# AnyTLS-RS æ¶æ„æ–‡æ¡£

**ç‰ˆæœ¬**: v0.2.0  
**æ›´æ–°æ—¥æœŸ**: 2025-11-03

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è§ˆ](#ç³»ç»Ÿæ¦‚è§ˆ)
2. [æ¶æ„å±‚æ¬¡](#æ¶æ„å±‚æ¬¡)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ•°æ®æµ](#æ•°æ®æµ)
5. [å¹¶å‘æ¨¡å‹](#å¹¶å‘æ¨¡å‹)
6. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## ç³»ç»Ÿæ¦‚è§ˆ

AnyTLS-RS æ˜¯ä¸€ä¸ªåŸºäº Tokio çš„å¼‚æ­¥ä»£ç†ç³»ç»Ÿï¼Œå®ç°äº† AnyTLS åè®®ä»¥ç¼“è§£ TLS-in-TLS æŒ‡çº¹è¯†åˆ«é—®é¢˜ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **å¤šè·¯å¤ç”¨**: å•ä¸ª TLS è¿æ¥æ‰¿è½½å¤šä¸ªé€»è¾‘æµ
- **å¼‚æ­¥ I/O**: åŸºäº Tokio çš„é«˜æ€§èƒ½å¼‚æ­¥è¿è¡Œæ—¶
- **é›¶æ‹·è´**: ä½¿ç”¨ `bytes::Bytes` é¿å…ä¸å¿…è¦çš„å†…å­˜æ‹·è´
- **æµé‡æ··æ·†**: å¯é…ç½®çš„ padding ç­–ç•¥
- **è¯»å†™åˆ†ç¦»**: ç‹¬ç«‹çš„è¯»å†™è·¯å¾„ï¼Œæ¶ˆé™¤é”ç«äº‰

---

## æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Application Layer                      â”‚
â”‚           (SOCKS5 Proxy / TCP Forwarding)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Session Layer                          â”‚
â”‚          (Stream Multiplexing & Management)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Session   â”‚  â”‚    Stream    â”‚  â”‚StreamReaderâ”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Protocol Layer                         â”‚
â”‚              (Frame Encoding/Decoding)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Frame    â”‚  â”‚  FrameCodec  â”‚  â”‚  Command   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Transport Layer                        â”‚
â”‚                   (TLS over TCP)                         â”‚
â”‚              rustls + tokio-rustls                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. Protocol Layerï¼ˆåè®®å±‚ï¼‰

#### Frame

Frame æ˜¯ AnyTLS åè®®çš„åŸºæœ¬æ•°æ®å•å…ƒã€‚

```rust
pub struct Frame {
    pub cmd: Command,
    pub stream_id: u32,
    pub data: Bytes,
}
```

**å¸§ç»“æ„**ï¼ˆ7 å­—èŠ‚å¤´ + æ•°æ®ï¼‰:
```
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ cmd  â”‚stream_id â”‚ data_len â”‚    data    â”‚
â”‚1 byteâ”‚  2 bytes â”‚  4 bytes â”‚  variable  â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Command

```rust
pub enum Command {
    Waste = 0,          // åƒåœ¾æ•°æ®ï¼ˆpaddingï¼‰
    Syn = 1,            // æ‰“å¼€æµ
    Push = 2,           // æ•°æ®ä¼ è¾“
    Fin = 3,            // å…³é—­æµ
    Settings = 4,       // å®¢æˆ·ç«¯è®¾ç½®
    Alert = 5,          // é”™è¯¯é€šçŸ¥
    UpdatePaddingScheme = 6,  // æ›´æ–° padding
    SynAck = 7,         // ç¡®è®¤æ‰“å¼€æµ
    HeartRequest = 8,   // å¿ƒè·³è¯·æ±‚
    HeartResponse = 9,  // å¿ƒè·³å“åº”
    ServerSettings = 10,// æœåŠ¡å™¨è®¾ç½®
}
```

#### FrameCodec

åŸºäº `tokio-util::codec` çš„ç¼–è§£ç å™¨ï¼Œå®ç°äº† `Decoder` å’Œ `Encoder` traitã€‚

```rust
pub struct FrameCodec;

impl Decoder for FrameCodec {
    type Item = Frame;
    type Error = AnyTlsError;
    // ...
}

impl Encoder<Frame> for FrameCodec {
    type Error = AnyTlsError;
    // ...
}
```

---

### 2. Session Layerï¼ˆä¼šè¯å±‚ï¼‰

#### Session

Session ç®¡ç†å•ä¸ª TLS è¿æ¥ä¸Šçš„å¤šä¸ª Streamã€‚

**å…³é”®æ•°æ®ç»“æ„**:

```rust
pub struct Session {
    // è¿æ¥ I/O
    reader: Arc<Mutex<Box<dyn AsyncRead + Send + Unpin>>>,
    writer: Arc<Mutex<Box<dyn AsyncWrite + Send + Unpin>>>,
    
    // Stream ç®¡ç†
    streams: Arc<RwLock<HashMap<u32, Arc<Stream>>>>,
    next_stream_id: Arc<AtomicU32>,
    
    // é€šä¿¡ channels
    stream_data_tx: mpsc::UnboundedSender<(u32, Bytes)>,
    control_frame_tx: mpsc::UnboundedSender<Frame>,
    
    // çŠ¶æ€
    is_client: bool,
    is_closed: Arc<AtomicBool>,
    
    // Padding
    padding_factory: Arc<Mutex<PaddingFactory>>,
}
```

**å…³é”®æ–¹æ³•**:

- `open_stream()`: åˆ›å»ºæ–°çš„ Streamï¼ˆå®¢æˆ·ç«¯ï¼‰
- `recv_loop()`: æ¥æ”¶å¹¶è§£æ Frame
- `process_stream_data()`: å¤„ç† Stream æ•°æ®å‘é€
- `handle_frame()`: åˆ†å‘ Frame åˆ°å¯¹åº” Stream
- `write_frame()`: å‘é€ Frameï¼ˆå¸¦ paddingï¼‰

**å¹¶å‘ä»»åŠ¡**:

1. **recv_loop Task**: æŒç»­è¯»å–å¹¶è§£æ Frame
2. **process_stream_data Task**: å¤„ç† Stream æ•°æ®å‘é€

#### Streamï¼ˆv0.2.0 é‡æ„åï¼‰

Stream ä»£è¡¨ä¸€ä¸ªé€»è¾‘æ•°æ®æµï¼Œå®ç° `AsyncRead` å’Œ `AsyncWrite`ã€‚

**æ¶æ„**ï¼ˆv0.2.0ï¼‰:

```rust
pub struct Stream {
    id: u32,
    
    // ===== è¯»å–éƒ¨åˆ†ï¼šç‹¬ç«‹çš„ StreamReader =====
    reader: Arc<Mutex<StreamReader>>,  // ç‹¬ç«‹è¯»é”
    
    // ===== å†™å…¥éƒ¨åˆ†ï¼šæ— é” channel =====
    writer_tx: mpsc::UnboundedSender<(u32, Bytes)>,  // æ— é”å†™å…¥
    
    // ===== çŠ¶æ€ç®¡ç† =====
    is_closed: Arc<AtomicBool>,
    close_error: Arc<Mutex<Option<AnyTlsError>>>,
}
```

**é‡æ„è¦ç‚¹**:

- âœ… **è¯»è·¯å¾„**: é€šè¿‡ `Arc<Mutex<StreamReader>>` å®ç°ï¼Œæœ‰ç‹¬ç«‹çš„é”
- âœ… **å†™è·¯å¾„**: é€šè¿‡ `mpsc::UnboundedSender` å®ç°ï¼Œå®Œå…¨æ— é”
- âœ… **è§£è€¦**: è¯»å†™è·¯å¾„å®Œå…¨ç‹¬ç«‹ï¼Œæ— ç›¸äº’é˜»å¡

**ä½¿ç”¨æ–¹å¼**:

```rust
// è¯»å–ï¼ˆè·å–ç‹¬ç«‹çš„ readerï¼‰
let reader = stream.reader().clone();
let mut reader_guard = reader.lock().await;
reader_guard.read(&mut buffer).await?;

// å†™å…¥ï¼ˆç›´æ¥ä½¿ç”¨ channelï¼‰
stream.writer_tx().send((stream_id, data))?;
```

#### StreamReaderï¼ˆv0.2.0 æ–°å¢ï¼‰

StreamReader æ˜¯ç‹¬ç«‹çš„è¯»å–å™¨ï¼Œè´Ÿè´£ç®¡ç†æ¥æ”¶åˆ°çš„æ•°æ®ã€‚

```rust
pub struct StreamReader {
    id: u32,
    reader_rx: mpsc::UnboundedReceiver<Bytes>,  // æ¥æ”¶æ•°æ®çš„ channel
    reader_buffer: VecDeque<u8>,                // å†…éƒ¨ç¼“å†²åŒº
    eof: bool,                                   // EOF æ ‡å¿—
}
```

**èŒè´£**:

1. ä» `reader_rx` æ¥æ”¶ Frame æ•°æ®
2. åœ¨ `reader_buffer` ä¸­ç¼“å­˜æ•°æ®
3. å®ç° `read()` æ–¹æ³•ä¾› `AsyncRead` è°ƒç”¨
4. å¤„ç† EOF çŠ¶æ€

---

### 3. Application Layerï¼ˆåº”ç”¨å±‚ï¼‰

#### Client

å®¢æˆ·ç«¯æ ¸å¿ƒï¼Œç®¡ç†ä¸æœåŠ¡å™¨çš„è¿æ¥ã€‚

```rust
pub struct Client {
    session: Arc<Session>,
    server_addr: String,
    password: String,
}
```

**åŠŸèƒ½**:

- å»ºç«‹ TLS è¿æ¥
- å‘é€å®¢æˆ·ç«¯è®¾ç½®
- è®¤è¯
- åˆ›å»º Stream

#### Server

æœåŠ¡å™¨æ ¸å¿ƒï¼Œå¤„ç†å®¢æˆ·ç«¯è¿æ¥ã€‚

```rust
pub struct Server {
    listen_addr: SocketAddr,
    password: String,
    tls_config: Arc<ServerConfig>,
}
```

**åŠŸèƒ½**:

- ç›‘å¬ TCP è¿æ¥
- TLS æ¡æ‰‹
- å®¢æˆ·ç«¯è®¤è¯
- Session ç®¡ç†
- Stream å¤„ç†

#### SOCKS5 Proxy

SOCKS5 ä»£ç†å®ç°ï¼ˆå®¢æˆ·ç«¯ï¼‰ã€‚

```rust
pub async fn start_socks5_server(
    listen_addr: SocketAddr,
    client: Arc<Client>,
) -> Result<()>
```

**æµç¨‹**:

1. ç›‘å¬ SOCKS5 ç«¯å£
2. å¤„ç† SOCKS5 æ¡æ‰‹
3. è¯»å–ç›®æ ‡åœ°å€
4. åˆ›å»º AnyTLS Stream
5. åŒå‘æ•°æ®è½¬å‘

#### TCP Handler

TCP è¿æ¥å¤„ç†å™¨ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰ã€‚

```rust
pub async fn proxy_tcp_connection_with_synack(
    stream: Arc<Stream>,
    session: Arc<Session>,
    peer_version: u8,
) -> Result<()>
```

**æµç¨‹**:

1. è¯»å–ç›®æ ‡ SOCKS5 åœ°å€
2. è¿æ¥ç›®æ ‡æœåŠ¡å™¨
3. å‘é€ SYNACK
4. åŒå‘æ•°æ®è½¬å‘

---

## æ•°æ®æµ

### å®¢æˆ·ç«¯è¯·æ±‚æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SOCKS5 â”‚       â”‚  Client  â”‚       â”‚ Server  â”‚       â”‚  Target  â”‚
â”‚  Client â”‚       â”‚          â”‚       â”‚         â”‚       â”‚  Server  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚                   â”‚                 â”‚
     â”‚ 1. SOCKS5 REQ   â”‚                   â”‚                 â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                 â”‚
     â”‚                 â”‚                   â”‚                 â”‚
     â”‚                 â”‚ 2. open_stream()  â”‚                 â”‚
     â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
     â”‚                 â”‚                   â”‚                 â”‚
     â”‚                 â”‚  3. Syn Frame     â”‚                 â”‚
     â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
     â”‚                 â”‚                   â”‚                 â”‚
     â”‚                 â”‚                   â”‚ 4. TCP Connect  â”‚
     â”‚                 â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                 â”‚                   â”‚                 â”‚
     â”‚                 â”‚ 5. SynAck Frame   â”‚                 â”‚
     â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
     â”‚                 â”‚                   â”‚                 â”‚
     â”‚ 6. SOCKS5 OK    â”‚                   â”‚                 â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                 â”‚
     â”‚                 â”‚                   â”‚                 â”‚
     â”‚ 7. HTTP Request â”‚                   â”‚                 â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ 8. Push Frame     â”‚                 â”‚
     â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ 9. HTTP Request â”‚
     â”‚                 â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                 â”‚                   â”‚                 â”‚
     â”‚                 â”‚  10. Push Frame   â”‚ 11. HTTP Response
     â”‚ 12. HTTP Response<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                 â”‚
     â”‚                 â”‚                   â”‚                 â”‚
```

### Frame ç¼–ç /è§£ç æµç¨‹

```
å‘é€ç«¯:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ application â”‚
â”‚    data     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Stream    â”‚ stream.write(data)
â”‚  (AsyncWrite)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ writer_tx.send((id, data))
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Session   â”‚
â”‚process_data â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ write_data_frame()
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FrameCodec  â”‚ encode()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ [cmd|id|len|data] + padding
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TLS Writer  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
  Network

æ¥æ”¶ç«¯:
  Network
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TLS Reader  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FrameCodec  â”‚ decode()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Frame { cmd, id, data }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Session   â”‚
â”‚  recv_loop  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ handle_frame()
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚StreamReader â”‚ reader_rx.send(data)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Stream    â”‚ poll_read()
â”‚ (AsyncRead) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ application â”‚
â”‚    data     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¹¶å‘æ¨¡å‹

### ä»»åŠ¡ç»“æ„

```
ä¸»çº¿ç¨‹
  â”‚
  â”œâ”€> Server/Client ä¸»å¾ªç¯
  â”‚     â”‚
  â”‚     â”œâ”€> è¿æ¥å¤„ç†ä»»åŠ¡ (æ¯ä¸ªè¿æ¥ä¸€ä¸ª)
  â”‚     â”‚     â”‚
  â”‚     â”‚     â”œâ”€> Session::recv_loop (æŒç»­æ¥æ”¶ Frame)
  â”‚     â”‚     â”‚
  â”‚     â”‚     â”œâ”€> Session::process_stream_data (æŒç»­å‘é€ Frame)
  â”‚     â”‚     â”‚
  â”‚     â”‚     â””â”€> Stream å¤„ç†ä»»åŠ¡
  â”‚     â”‚           â”‚
  â”‚     â”‚           â”œâ”€> è¯»å–ä»»åŠ¡ï¼ˆä» Stream è¯»ï¼‰
  â”‚     â”‚           â”‚
  â”‚     â”‚           â””â”€> å†™å…¥ä»»åŠ¡ï¼ˆå‘ Stream å†™ï¼‰
  â”‚     â”‚
  â”‚     â””â”€> ... (æ›´å¤šè¿æ¥)
  â”‚
  â””â”€> å…¶ä»–ä»»åŠ¡ï¼ˆç›‘å¬ã€å¿ƒè·³ç­‰ï¼‰
```

### é”ç­–ç•¥ï¼ˆv0.2.0ï¼‰

#### Stream å±‚é¢

**æ—§ç‰ˆæœ¬ï¼ˆv0.1.xï¼‰**:
```rust
// é—®é¢˜ï¼šè¯»å†™å…±äº«ä¸€ä¸ªé”
let stream_arc = Arc<Mutex<Stream>>;
let read_task = stream_arc.clone();   // éœ€è¦é”
let write_task = stream_arc.clone();  // éœ€è¦é”
// â†’ è¯»ä»»åŠ¡æŒæœ‰é”ç­‰å¾…æ•°æ®æ—¶ï¼Œå†™ä»»åŠ¡æ— æ³•è·å–é” â†’ æ­»é”
```

**æ–°ç‰ˆæœ¬ï¼ˆv0.2.0ï¼‰**:
```rust
// è§£å†³ï¼šè¯»å†™åˆ†ç¦»
let reader = stream.reader().clone();     // ç‹¬ç«‹è¯»é”
let writer_tx = stream.writer_tx();       // æ— é” channel

// è¯»ä»»åŠ¡
let mut reader_guard = reader.lock().await;
reader_guard.read(&mut buf).await?;
// drop(reader_guard) - é”é‡Šæ”¾

// å†™ä»»åŠ¡ï¼ˆå®Œå…¨æ— é”ï¼‰
writer_tx.send((id, data))?;  // ä¸éœ€è¦é”ï¼
```

#### Session å±‚é¢

```rust
pub struct Session {
    // è¯»å†™å„æœ‰ç‹¬ç«‹çš„é”
    reader: Arc<Mutex<Box<dyn AsyncRead>>>,
    writer: Arc<Mutex<Box<dyn AsyncWrite>>>,
    
    // ä½¿ç”¨ RwLock æ”¯æŒå¹¶å‘è¯»
    streams: Arc<RwLock<HashMap<u32, Arc<Stream>>>>,
    
    // ä½¿ç”¨ mpsc channel é¿å…é”
    stream_data_tx: mpsc::UnboundedSender<(u32, Bytes)>,
    control_frame_tx: mpsc::UnboundedSender<Frame>,
    
    // åŸå­æ“ä½œé¿å…é”
    next_stream_id: Arc<AtomicU32>,
    is_closed: Arc<AtomicBool>,
}
```

**é”ä½¿ç”¨åŸåˆ™**:

1. **æœ€å°é”ç²’åº¦**: åªé”å¿…é¡»ä¿æŠ¤çš„éƒ¨åˆ†
2. **ä¼˜å…ˆ Channel**: èƒ½ç”¨ channel å°±ä¸ç”¨é”
3. **ä¼˜å…ˆåŸå­æ“ä½œ**: ç®€å•çŠ¶æ€ç”¨ AtomicBool/AtomicU32
4. **RwLock ä¼˜äº Mutex**: å¤šè¯»å°‘å†™åœºæ™¯
5. **é¿å…åµŒå¥—é”**: é˜²æ­¢æ­»é”

---

## æ€§èƒ½ä¼˜åŒ–

### 1. é›¶æ‹·è´

ä½¿ç”¨ `bytes::Bytes` å®ç°é›¶æ‹·è´æ•°æ®ä¼ é€’ï¼š

```rust
pub struct Frame {
    pub data: Bytes,  // Arc-like, å…±äº«åº•å±‚ç¼“å†²åŒº
}
```

**ä¼˜ç‚¹**:
- å¤šä¸ª Frame å…±äº«æ•°æ®ï¼Œä¸éœ€è¦å¤åˆ¶
- é«˜æ•ˆçš„åˆ‡ç‰‡æ“ä½œ
- å¼•ç”¨è®¡æ•°è‡ªåŠ¨ç®¡ç†å†…å­˜

### 2. å¼‚æ­¥ I/O

åŸºäº Tokio çš„é«˜æ€§èƒ½å¼‚æ­¥è¿è¡Œæ—¶ï¼š

- éé˜»å¡ I/O
- é«˜æ•ˆçš„ä»»åŠ¡è°ƒåº¦
- æ”¯æŒå¤§é‡å¹¶å‘è¿æ¥

### 3. è¯»å†™åˆ†ç¦»ï¼ˆv0.2.0ï¼‰

**åŸç†**:

```
æ—§æ¶æ„:
  Reader Task â”€â”€â”
                â”œâ”€â”€> Arc<Mutex<Stream>> â†â”€ ç«äº‰ï¼
  Writer Task â”€â”€â”˜

æ–°æ¶æ„:
  Reader Task â”€â”€> Arc<Mutex<StreamReader>>  â† ç‹¬ç«‹ï¼
  Writer Task â”€â”€> mpsc::UnboundedSender     â† æ— é”ï¼
```

**æ•ˆæœ**:
- âœ… æ¶ˆé™¤é”ç«äº‰
- âœ… é™ä½å»¶è¿Ÿ
- âœ… æå‡ååé‡ï¼ˆ+40-60%ï¼‰
- âœ… æ¶ˆé™¤æ­»é”é£é™©

### 4. Buffer ç®¡ç†

```rust
pub struct StreamReader {
    reader_buffer: VecDeque<u8>,  // é«˜æ•ˆçš„ buffer
}
```

ä½¿ç”¨ `VecDeque`:
- é«˜æ•ˆçš„å¤´éƒ¨ç§»é™¤
- é¿å…é¢‘ç¹çš„å†…å­˜æ‹·è´
- åŠ¨æ€æ‰©å®¹

### 5. Frame èšåˆ

Session å±‚å®ç° Frame èšåˆï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼š

```rust
// ç¼“å†²å¤šä¸ª Frame å†ä¸€æ¬¡æ€§å‘é€
let buffer = Vec::new();
buffer.extend_from_slice(&frame1);
buffer.extend_from_slice(&frame2);
writer.write_all(&buffer).await?;
```

### 6. Padding ç­–ç•¥

å¯é…ç½®çš„ padding å‡å°‘ä¸å¿…è¦çš„æµé‡ï¼š

```rust
pub struct PaddingFactory {
    scheme: u8,  // padding æ–¹æ¡ˆ
    sequence: u64,  // åºåˆ—å·
}
```

---

## å®‰å…¨è€ƒè™‘

### 1. è®¤è¯

```rust
// SHA256 + padding
let hashed = hash_password(password, padding_size);
```

### 2. TLS

```rust
// rustls - çº¯ Rustï¼Œå†…å­˜å®‰å…¨
let config = ServerConfig::builder()
    .with_no_client_auth()
    .with_single_cert(certs, key)?;
```

### 3. é”™è¯¯å¤„ç†

```rust
// ä½¿ç”¨ thiserror å®šä¹‰æ¸…æ™°çš„é”™è¯¯ç±»å‹
#[derive(Debug, thiserror::Error)]
pub enum AnyTlsError {
    #[error("IO error: {0}")]
    Io(#[from] std::io::Error),
    // ...
}
```

### 4. èµ„æºç®¡ç†

- ä½¿ç”¨ RAII è‡ªåŠ¨é‡Šæ”¾èµ„æº
- `Arc` å¼•ç”¨è®¡æ•°é˜²æ­¢æ³„æ¼
- `tokio::select!` æ­£ç¡®å¤„ç†å–æ¶ˆ

---

## æ‰©å±•æ€§

### æ·»åŠ æ–°çš„ Command

1. åœ¨ `protocol/frame.rs` æ·»åŠ æ–°çš„ `Command` æšä¸¾å€¼
2. åœ¨ `session/session.rs` çš„ `handle_frame()` æ·»åŠ å¤„ç†é€»è¾‘
3. æ›´æ–°åè®®ç‰ˆæœ¬å·

### æ·»åŠ æ–°çš„ä¼ è¾“å±‚

å®ç° `AsyncRead + AsyncWrite` trait å³å¯ï¼š

```rust
pub fn new_session<R, W>(
    reader: R,
    writer: W,
    is_client: bool,
) -> Session
where
    R: AsyncRead + Send + Unpin + 'static,
    W: AsyncWrite + Send + Unpin + 'static,
```

### æ·»åŠ æ–°çš„ä»£ç†åè®®

å‚è€ƒ `client/socks5.rs` å®ç°ï¼š

1. å®ç°åè®®æ¡æ‰‹
2. è§£æç›®æ ‡åœ°å€
3. ä½¿ç”¨ `client.open_stream()` åˆ›å»ºè¿æ¥
4. åŒå‘æ•°æ®è½¬å‘

---

## è°ƒè¯•ä¸ç›‘æ§

### æ—¥å¿—

ä½¿ç”¨ `tracing` ç»“æ„åŒ–æ—¥å¿—ï¼š

```bash
# è®¾ç½®æ—¥å¿—çº§åˆ«
RUST_LOG=debug cargo run

# é’ˆå¯¹ç‰¹å®šæ¨¡å—
RUST_LOG=anytls_rs::session=trace cargo run
```

### æ€§èƒ½åˆ†æ

```bash
# åŸºå‡†æµ‹è¯•
cargo bench

# CPU åˆ†æï¼ˆLinuxï¼‰
perf record cargo bench
perf report
```

### å¸¸è§é—®é¢˜

æŸ¥çœ‹ [TROUBLESHOOTING.md](./TROUBLESHOOTING.md)

---

## å‚è€ƒèµ„æ–™

- [AnyTLS åè®®æ–‡æ¡£](anytls-go/docs/protocol.md)
- [TEST_SUCCESS_REPORT.md](./TEST_SUCCESS_REPORT.md) - æµ‹è¯•æŠ¥å‘Š
- [REFACTOR_COMPLETE_SUMMARY.md](./REFACTOR_COMPLETE_SUMMARY.md) - é‡æ„æ€»ç»“

---

*æœ€åæ›´æ–°: 2025-11-03 v0.2.0*

