# CI/CD æµç¨‹è¯¦è§£ä¸ Benchmark æœ€ä½³å®è·µ

**æœ€åæ›´æ–°**: 2025-11-04

---

## ğŸ“‹ ç›®å½•

1. [CI/CD æµç¨‹æ¦‚è§ˆ](#cicd-æµç¨‹æ¦‚è§ˆ)
2. [å½“å‰é¡¹ç›® CI/CD æ¶æ„](#å½“å‰é¡¹ç›®-cicd-æ¶æ„)
3. [Benchmark æœ€ä½³å®è·µ](#benchmark-æœ€ä½³å®è·µ)
4. [è¡Œä¸šæƒ¯ä¾‹ä¸å»ºè®®](#è¡Œä¸šæƒ¯ä¾‹ä¸å»ºè®®)
5. [ä¼˜åŒ–å»ºè®®](#ä¼˜åŒ–å»ºè®®)

---

## CI/CD æµç¨‹æ¦‚è§ˆ

### ä»€ä¹ˆæ˜¯ CI/CDï¼Ÿ

**CI (Continuous Integration - æŒç»­é›†æˆ)**:
- é¢‘ç¹åœ°å°†ä»£ç å˜æ›´åˆå¹¶åˆ°ä¸»åˆ†æ”¯
- è‡ªåŠ¨è¿è¡Œæµ‹è¯•ã€æ„å»ºã€ä»£ç æ£€æŸ¥
- å°½æ—©å‘ç°é›†æˆé—®é¢˜

**CD (Continuous Deployment/Delivery - æŒç»­éƒ¨ç½²/äº¤ä»˜)**:
- è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆDeploymentï¼‰
- æˆ–è‡ªåŠ¨å‡†å¤‡å‘å¸ƒç‰ˆæœ¬ï¼ˆDeliveryï¼‰

### å…¸å‹çš„ CI/CD æµç¨‹

```
å¼€å‘è€…æäº¤ä»£ç 
    â†“
è‡ªåŠ¨è§¦å‘ CI Pipeline
    â†“
ä»£ç è´¨é‡æ£€æŸ¥ (æ ¼å¼åŒ–ã€Lint)
    â†“
ç¼–è¯‘æ„å»º
    â†“
è¿è¡Œæµ‹è¯•
    â†“
æ€§èƒ½æµ‹è¯• (Benchmark) - å¯é€‰
    â†“
å®‰å…¨æ‰«æ - å¯é€‰
    â†“
ç”Ÿæˆæ„å»ºäº§ç‰©
    â†“
è‡ªåŠ¨éƒ¨ç½²/å‘å¸ƒ (CD)
```

---

## å½“å‰é¡¹ç›® CI/CD æ¶æ„

### 1. CI Workflow (`.github/workflows/ci.yml`)

**è§¦å‘æ¡ä»¶**:
- Push åˆ° `main` æˆ– `develop` åˆ†æ”¯
- Pull Request åˆ° `main` æˆ– `develop` åˆ†æ”¯

**æ‰§è¡Œçš„ä»»åŠ¡**:

#### Job 1: Test (å¤šå¹³å°æµ‹è¯•)
- **å¹³å°çŸ©é˜µ**: 
  - Ubuntu, macOS, Windows
  - Rust stable, beta
- **æ­¥éª¤**:
  1. ä»£ç æ ¼å¼åŒ–æ£€æŸ¥ (`cargo fmt --check`)
  2. Clippy ä»£ç æ£€æŸ¥ (`cargo clippy`)
  3. æ„å»ºé¡¹ç›® (`cargo build`)
  4. è¿è¡Œæµ‹è¯• (`cargo test`)
  5. æ„å»ºå‘å¸ƒç‰ˆæœ¬äºŒè¿›åˆ¶æ–‡ä»¶
  6. ä¸Šä¼ æ„å»ºäº§ç‰©

#### Job 2: Benchmark (æ€§èƒ½æµ‹è¯•)
- **è§¦å‘æ¡ä»¶**: ä»…å½“ push åˆ° `main` åˆ†æ”¯æ—¶
- **æ­¥éª¤**:
  1. è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
  2. ä¿å­˜åŸºå‡†çº¿ (`--save-baseline`)
  3. ä¸Šä¼ åŸºå‡†æµ‹è¯•ç»“æœ

#### Job 3: Security Audit (å®‰å…¨å®¡è®¡)
- **æ­¥éª¤**:
  1. è¿è¡Œ `cargo audit` æ£€æŸ¥ä¾èµ–æ¼æ´
  2. `continue-on-error: true` - ä¸é˜»å¡æ„å»º

**ç‰¹ç‚¹**:
- âœ… å¹¶è¡Œæ‰§è¡Œï¼Œæé«˜æ•ˆç‡
- âœ… å¤šå¹³å°éªŒè¯ï¼Œç¡®ä¿å…¼å®¹æ€§
- âš ï¸ Benchmark åªåœ¨ main åˆ†æ”¯è¿è¡Œï¼ˆå¯èƒ½ä¸å¤Ÿé¢‘ç¹ï¼‰

### 2. Benchmark Workflow (`.github/workflows/benchmark.yml`)

**è§¦å‘æ¡ä»¶**:
- Push åˆ° `main` åˆ†æ”¯ï¼ˆç‰¹å®šæ–‡ä»¶å˜æ›´ï¼‰
- Pull Request åˆ° `main` åˆ†æ”¯
- **å®šæ—¶ä»»åŠ¡**: æ¯å¤© UTC 2:00 AM
- **æ‰‹åŠ¨è§¦å‘**: `workflow_dispatch`

**æ‰§è¡Œçš„ä»»åŠ¡**:
1. è¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•
2. **PR æ—¶**: ä¸ main åˆ†æ”¯åŸºçº¿å¯¹æ¯”
3. ä¸Šä¼ åŸºå‡†æµ‹è¯•ç»“æœ
4. **PR æ—¶**: åœ¨ PR ä¸­è¯„è®ºåŸºå‡†æµ‹è¯•ç»“æœ

**ç‰¹ç‚¹**:
- âœ… æ”¯æŒæ€§èƒ½å›å½’æ£€æµ‹
- âœ… PR ä¸­è‡ªåŠ¨å¯¹æ¯”æ€§èƒ½
- âœ… å®šæ—¶è¿è¡Œç¡®ä¿ç¨³å®šæ€§

### 3. Release Workflow (`.github/workflows/release.yml`)

**è§¦å‘æ¡ä»¶**:
- æ¨é€ç‰ˆæœ¬æ ‡ç­¾ (`v*`)
- æ‰‹åŠ¨è§¦å‘

**æ‰§è¡Œçš„ä»»åŠ¡**:

#### Job 1: Build (å¤šå¹³å°æ„å»º)
- **å¹³å°**: Linux (x86_64, ARM64), macOS (x86_64, ARM64), Windows (x86_64, ARM64)
- **æ­¥éª¤**:
  1. äº¤å‰ç¼–è¯‘
  2. åˆ›å»ºå‘å¸ƒå½’æ¡£ï¼ˆtar.gz æˆ– zipï¼‰
  3. ä¸Šä¼ æ„å»ºäº§ç‰©

#### Job 2: Checksum (ç”Ÿæˆæ ¡éªŒå’Œ)
- ä¸ºæ‰€æœ‰å‘å¸ƒæ–‡ä»¶ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ

#### Job 3: Publish (å‘å¸ƒåˆ° crates.io)
- éªŒè¯åŒ…å…ƒæ•°æ®
- å‘å¸ƒåˆ° crates.io

#### Job 4: Create Release (åˆ›å»º GitHub Release)
- ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
- ç”Ÿæˆå‘å¸ƒè¯´æ˜
- åˆ›å»º GitHub Release

**ç‰¹ç‚¹**:
- âœ… å¤šå¹³å°æ„å»º
- âœ… è‡ªåŠ¨åŒ–å‘å¸ƒæµç¨‹
- âœ… åŒ…å«æ ¡éªŒå’ŒéªŒè¯

### 4. Publish Workflow (`.github/workflows/publish.yml`)

**è§¦å‘æ¡ä»¶**:
- GitHub Release å‘å¸ƒ
- æ‰‹åŠ¨è§¦å‘

**æ‰§è¡Œçš„ä»»åŠ¡**:
1. ä»£ç è´¨é‡æ£€æŸ¥
2. æ„å»ºå’Œæµ‹è¯•
3. éªŒè¯åŒ…
4. å‘å¸ƒåˆ° crates.io

---

## Benchmark æœ€ä½³å®è·µ

### ä»€ä¹ˆæ—¶å€™è¿è¡Œ Benchmarkï¼Ÿ

#### âœ… æ¨èåœºæ™¯

1. **Pull Request æ—¶** (é«˜ä¼˜å…ˆçº§)
   - **ç›®çš„**: æ£€æµ‹æ€§èƒ½å›å½’
   - **æ—¶æœº**: PR æäº¤å
   - **ä¼˜åŠ¿**: åœ¨åˆå¹¶å‰å‘ç°é—®é¢˜
   - **è¡Œä¸šæƒ¯ä¾‹**: âœ… ä¸»æµåšæ³•

2. **å‘å¸ƒå‰** (å¿…éœ€)
   - **ç›®çš„**: éªŒè¯å‘å¸ƒç‰ˆæœ¬æ€§èƒ½
   - **æ—¶æœº**: Release candidate é˜¶æ®µ
   - **ä¼˜åŠ¿**: ç¡®ä¿å‘å¸ƒè´¨é‡
   - **è¡Œä¸šæƒ¯ä¾‹**: âœ… æ ‡å‡†åšæ³•

3. **å®šæ—¶è¿è¡Œ** (æ¨è)
   - **ç›®çš„**: æ£€æµ‹é•¿æœŸæ€§èƒ½è¶‹åŠ¿
   - **æ—¶æœº**: æ¯å¤©æˆ–æ¯å‘¨
   - **ä¼˜åŠ¿**: å‘ç°æ¸è¿›å¼æ€§èƒ½é€€åŒ–
   - **è¡Œä¸šæƒ¯ä¾‹**: âœ… æ¨èåšæ³•

4. **å…³é”®ä»£ç å˜æ›´å** (æ¨è)
   - **ç›®çš„**: éªŒè¯æ€§èƒ½ä¼˜åŒ–æ•ˆæœ
   - **æ—¶æœº**: æ€§èƒ½ç›¸å…³ PR
   - **ä¼˜åŠ¿**: åŠæ—¶éªŒè¯æ”¹è¿›
   - **è¡Œä¸šæƒ¯ä¾‹**: âœ… æœ€ä½³å®è·µ

#### âš ï¸ ä¸æ¨èåœºæ™¯

1. **æ¯æ¬¡æäº¤éƒ½è¿è¡Œ** (ä¸æ¨è)
   - **é—®é¢˜**: æ¶ˆè€—èµ„æºï¼ŒCI æ—¶é—´è¿‡é•¿
   - **è¡Œä¸šæƒ¯ä¾‹**: âŒ ä¸å¸¸è§

2. **åªåœ¨ main åˆ†æ”¯è¿è¡Œ** (é™åˆ¶æ€§)
   - **é—®é¢˜**: PR ä¸­æ— æ³•æ£€æµ‹æ€§èƒ½å›å½’
   - **å½“å‰çŠ¶æ€**: âš ï¸ ä½ çš„é¡¹ç›®æ˜¯è¿™æ ·
   - **è¡Œä¸šæƒ¯ä¾‹**: âŒ ä¸æ¨è

3. **ä»ä¸è¿è¡Œ** (ä¸æ¨è)
   - **é—®é¢˜**: æ— æ³•æ£€æµ‹æ€§èƒ½é—®é¢˜
   - **è¡Œä¸šæƒ¯ä¾‹**: âŒ ä¸ä¸“ä¸š

### Benchmark è§¦å‘ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | è§¦å‘æ—¶æœº | ä¼˜ç‚¹ | ç¼ºç‚¹ | è¡Œä¸šé‡‡ç”¨ç‡ |
|------|---------|------|------|-----------|
| **PR è§¦å‘** | æ¯ä¸ª PR | æ—©æœŸå‘ç°å›å½’ | èµ„æºæ¶ˆè€— | â­â­â­â­â­ (95%) |
| **å®šæ—¶è¿è¡Œ** | æ¯å¤©/æ¯å‘¨ | æ£€æµ‹è¶‹åŠ¿ | å»¶è¿Ÿå‘ç° | â­â­â­â­ (80%) |
| **å‘å¸ƒå‰** | Release tag | ç¡®ä¿è´¨é‡ | å‘ç°å¤ªæ™š | â­â­â­â­â­ (100%) |
| **å…³é”®å˜æ›´** | ç‰¹å®šæ–‡ä»¶ | ç²¾å‡†è§¦å‘ | é…ç½®å¤æ‚ | â­â­â­ (60%) |
| **æ¯æ¬¡æäº¤** | æ‰€æœ‰æäº¤ | å…¨é¢è¦†ç›– | èµ„æºæµªè´¹ | â­ (10%) |

### è¡Œä¸šæƒ¯ä¾‹ - çŸ¥åé¡¹ç›®å®è·µ

#### 1. **tokio-rs/tokio** (Rust å¼‚æ­¥è¿è¡Œæ—¶)
- âœ… PR æ—¶è¿è¡ŒåŸºå‡†æµ‹è¯•
- âœ… ä¸ä¸»åˆ†æ”¯å¯¹æ¯”
- âœ… PR è¯„è®ºä¸­æ˜¾ç¤ºæ€§èƒ½å˜åŒ–
- âœ… ä½¿ç”¨ `cargo-criterion` è¿›è¡Œå¯¹æ¯”

#### 2. **rust-lang/rust** (Rust ç¼–è¯‘å™¨)
- âœ… PR æ—¶è¿è¡Œæ€§èƒ½æµ‹è¯•
- âœ… ä½¿ç”¨ `rustc-perf` å·¥å…·
- âœ… è‡ªåŠ¨æ£€æµ‹æ€§èƒ½å›å½’
- âœ… é˜»å¡åˆå¹¶å¦‚æœæœ‰æ˜¾è‘—å›å½’ (>5%)

#### 3. **actix/actix-web** (Web æ¡†æ¶)
- âœ… PR æ—¶è¿è¡ŒåŸºå‡†æµ‹è¯•
- âœ… å®šæ—¶è¿è¡Œ (æ¯å‘¨)
- âœ… å‘å¸ƒå‰å®Œæ•´åŸºå‡†æµ‹è¯•

#### 4. **serde-rs/serde** (åºåˆ—åŒ–åº“)
- âœ… PR æ—¶è¿è¡ŒåŸºå‡†æµ‹è¯•
- âœ… ä½¿ç”¨ GitHub Actions
- âœ… ä¸Šä¼ åŸºå‡†æµ‹è¯•æŠ¥å‘Š

### æ¨èçš„ Benchmark ç­–ç•¥

#### ç­–ç•¥ A: è½»é‡çº§ (é€‚åˆå°å‹é¡¹ç›®)
```yaml
# PR æ—¶ï¼šå¿«é€ŸåŸºå‡†æµ‹è¯•ï¼ˆæŠ½æ ·ï¼‰
on:
  pull_request:
    branches: [main]
    
# å‘å¸ƒæ—¶ï¼šå®Œæ•´åŸºå‡†æµ‹è¯•
on:
  push:
    tags: ['v*']
```

#### ç­–ç•¥ B: æ ‡å‡† (æ¨èï¼Œé€‚åˆä¸­å‹é¡¹ç›®)
```yaml
# PR æ—¶ï¼šå®Œæ•´åŸºå‡†æµ‹è¯• + å¯¹æ¯”
on:
  pull_request:
    branches: [main]
    
# å®šæ—¶ï¼šæ£€æµ‹è¶‹åŠ¿
schedule:
  - cron: '0 2 * * *'  # æ¯å¤© 2 AM

# å‘å¸ƒæ—¶ï¼šéªŒè¯
on:
  push:
    tags: ['v*']
```

#### ç­–ç•¥ C: å®Œæ•´ (é€‚åˆå¤§å‹/æ€§èƒ½å…³é”®é¡¹ç›®)
```yaml
# PR æ—¶ï¼šå®Œæ•´åŸºå‡†æµ‹è¯•
on:
  pull_request:
    branches: [main]

# å…³é”®å˜æ›´ï¼šè‡ªåŠ¨è§¦å‘
on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'benches/**'

# å®šæ—¶ï¼šé•¿æœŸè¶‹åŠ¿
schedule:
  - cron: '0 2 * * *'  # æ¯å¤©
  - cron: '0 3 * * 0'  # æ¯å‘¨æ—¥

# å‘å¸ƒæ—¶ï¼šå®Œæ•´éªŒè¯
on:
  push:
    tags: ['v*']
```

---

## è¡Œä¸šæƒ¯ä¾‹ä¸å»ºè®®

### 1. CI/CD æœ€ä½³å®è·µ

#### âœ… åº”è¯¥åšçš„

1. **å¿«é€Ÿå¤±è´¥ (Fail Fast)**
   - ä»£ç æ£€æŸ¥åº”è¯¥æœ€å…ˆè¿è¡Œï¼ˆæœ€å¿«ï¼‰
   - æ ¼å¼åŒ– â†’ Clippy â†’ æ„å»º â†’ æµ‹è¯•

2. **å¹¶è¡Œæ‰§è¡Œ**
   - ä¸åŒå¹³å°çš„æµ‹è¯•åº”è¯¥å¹¶è¡Œ
   - æµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•å¯ä»¥å¹¶è¡Œ

3. **ç¼“å­˜ä¼˜åŒ–**
   - ç¼“å­˜ Cargo æ³¨å†Œè¡¨å’Œæ„å»ºç›®å½•
   - å‡å°‘ CI æ—¶é—´

4. **æ¡ä»¶æ‰§è¡Œ**
   - åªè¿è¡Œå¿…è¦çš„ä»»åŠ¡
   - ä½¿ç”¨ `paths` è¿‡æ»¤è§¦å‘æ¡ä»¶

5. **ç»“æœé€šçŸ¥**
   - PR ä¸­è‡ªåŠ¨è¯„è®ºç»“æœ
   - å¤±è´¥æ—¶é€šçŸ¥ç›¸å…³äººå‘˜

#### âŒ ä¸åº”è¯¥åšçš„

1. **é˜»å¡æ€§åŸºå‡†æµ‹è¯•**
   - ä¸è¦å› ä¸ºå°çš„æ€§èƒ½æ³¢åŠ¨é˜»å¡ PR
   - è®¾ç½®åˆç†çš„é˜ˆå€¼ï¼ˆå¦‚ 5%ï¼‰

2. **èµ„æºæµªè´¹**
   - ä¸è¦æ¯æ¬¡æäº¤éƒ½è¿è¡Œå®Œæ•´åŸºå‡†æµ‹è¯•
   - ä½¿ç”¨æŠ½æ ·æˆ–å¿«é€Ÿæ¨¡å¼

3. **å¿½ç•¥ç»“æœ**
   - ä¸è¦ä¸Šä¼ åŸºå‡†æµ‹è¯•ç»“æœä½†ä¸ä½¿ç”¨
   - åº”è¯¥è‡ªåŠ¨å¯¹æ¯”å’ŒæŠ¥å‘Š

### 2. Benchmark æœ€ä½³å®è·µ

#### âœ… æ¨èåšæ³•

1. **PR ä¸­å¯¹æ¯”æ€§èƒ½**
   ```yaml
   - name: Compare with baseline
     if: github.event_name == 'pull_request'
     run: cargo bench --baseline main --threshold 0.05
   ```

2. **è®¾ç½®åˆç†çš„é˜ˆå€¼**
   - 5% ä»¥å†…çš„å˜åŒ–é€šå¸¸å¯ä»¥æ¥å—
   - è¶…è¿‡ 10% åº”è¯¥è§†ä¸ºå›å½’

3. **ä½¿ç”¨ä¸“ç”¨å·¥å…·**
   - `cargo-criterion` - æ›´å¥½çš„å¯¹æ¯”å’ŒæŠ¥å‘Š
   - `criterion.rs` - æ ‡å‡†åŸºå‡†æµ‹è¯•æ¡†æ¶

4. **ä¿å­˜å†å²æ•°æ®**
   - ä¸Šä¼ åŸºå‡†æµ‹è¯•ç»“æœä½œä¸º artifact
   - ä¿ç•™ 30-90 å¤©

5. **å¯è§†åŒ–ç»“æœ**
   - ä½¿ç”¨ GitHub Actions æ³¨é‡Š
   - æˆ–é›†æˆåˆ° PR æè¿°ä¸­

#### âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒä¸€è‡´æ€§**
   - ä½¿ç”¨ç›¸åŒçš„è¿è¡Œç¯å¢ƒï¼ˆå¦‚ ubuntu-latestï¼‰
   - é¿å…åœ¨ä¸åŒæœºå™¨ä¸Šå¯¹æ¯”

2. **ç»Ÿè®¡æ˜¾è‘—æ€§**
   - åŸºå‡†æµ‹è¯•åº”è¯¥è¿è¡Œå¤šæ¬¡
   - ä½¿ç”¨ç»Ÿè®¡æ–¹æ³•åˆ¤æ–­æ˜¾è‘—æ€§

3. **èµ„æºæ¶ˆè€—**
   - åŸºå‡†æµ‹è¯•å¯èƒ½å¾ˆè€—æ—¶
   - è€ƒè™‘ä½¿ç”¨ `--test` æ¨¡å¼å¿«é€ŸéªŒè¯

### 3. æ€§èƒ½å›å½’æ£€æµ‹

#### é˜ˆå€¼è®¾ç½®

```rust
// ç¤ºä¾‹ï¼š5% é˜ˆå€¼
cargo bench --baseline main --threshold 0.05

// è§£è¯»ï¼š
// - æ€§èƒ½æå‡ >5%: âœ… é€šè¿‡
// - æ€§èƒ½å˜åŒ– <5%: âœ… é€šè¿‡ï¼ˆå¯æ¥å—çš„æ³¢åŠ¨ï¼‰
// - æ€§èƒ½ä¸‹é™ >5%: âŒ å¤±è´¥ï¼ˆéœ€è¦å®¡æŸ¥ï¼‰
```

#### å¤„ç†ç­–ç•¥

1. **è½»å¾®å›å½’ (<5%)**
   - è®°å½•ä½†å…è®¸åˆå¹¶
   - åœ¨ PR ä¸­æ ‡æ³¨

2. **ä¸­ç­‰å›å½’ (5-10%)**
   - è¦æ±‚å®¡æŸ¥
   - å¯èƒ½éœ€è¦å›é€€æˆ–ä¼˜åŒ–

3. **ä¸¥é‡å›å½’ (>10%)**
   - é˜»å¡åˆå¹¶
   - å¿…é¡»ä¿®å¤æˆ–æä¾›ç†ç”±

---

## ä¼˜åŒ–å»ºè®®

### å½“å‰é¡¹ç›®çš„é—®é¢˜

1. **Benchmark åªåœ¨ main åˆ†æ”¯è¿è¡Œ**
   - âŒ é—®é¢˜: PR ä¸­æ— æ³•æ£€æµ‹æ€§èƒ½å›å½’
   - âœ… å»ºè®®: åœ¨ PR æ—¶ä¹Ÿè¿è¡Œå¹¶å¯¹æ¯”

2. **ç¼ºå°‘æ€§èƒ½å›å½’æ£€æµ‹**
   - âŒ é—®é¢˜: åªä¿å­˜åŸºå‡†ï¼Œä¸å¯¹æ¯”
   - âœ… å»ºè®®: æ·»åŠ è‡ªåŠ¨å¯¹æ¯”é€»è¾‘

3. **åŸºå‡†æµ‹è¯•ç»“æœæœªå……åˆ†åˆ©ç”¨**
   - âŒ é—®é¢˜: ä¸Šä¼ äº†ä½†ä¸æ£€æŸ¥
   - âœ… å»ºè®®: åœ¨ PR ä¸­è‡ªåŠ¨è¯„è®ºç»“æœ

### æ¨èçš„æ”¹è¿›æ–¹æ¡ˆ

#### æ”¹è¿› 1: PR æ—¶è¿è¡Œ Benchmark

```yaml
# .github/workflows/benchmark.yml
on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'benches/**'
      - 'Cargo.toml'

jobs:
  benchmark:
    steps:
      - name: Run benchmarks on PR
        run: |
          cargo bench --bench $bench -- --save-baseline pr-${{ github.sha }}
      
      - name: Compare with main
        run: |
          # è·å– main åˆ†æ”¯çš„åŸºçº¿
          git checkout main
          cargo bench --bench $bench -- --save-baseline main
          
          # åˆ‡æ¢å› PR åˆ†æ”¯
          git checkout ${{ github.head_ref }}
          
          # å¯¹æ¯”
          cargo bench --bench $bench -- --baseline main --threshold 0.05
```

#### æ”¹è¿› 2: ä½¿ç”¨ cargo-criterion

```yaml
- name: Install cargo-criterion
  run: cargo install cargo-criterion --locked

- name: Compare benchmarks
  run: |
    cargo criterion --bench $bench --message-format=json | \
      cargo-criterion --baseline main --threshold 5%
```

#### æ”¹è¿› 3: PR è‡ªåŠ¨è¯„è®º

```yaml
- name: Comment benchmark results
  if: github.event_name == 'pull_request'
  uses: actions/github-script@v7
  with:
    script: |
      // è§£æåŸºå‡†æµ‹è¯•ç»“æœ
      // ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
      // åœ¨ PR ä¸­è¯„è®º
```

### å®Œæ•´çš„ä¼˜åŒ–é…ç½®ç¤ºä¾‹

```yaml
name: Benchmark

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'benches/**'
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'benches/**'
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© 2 AM UTC
  workflow_dispatch:

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache
        uses: actions/cache@v4
        with:
          path: target/
          key: bench-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run benchmarks (PR)
        if: github.event_name == 'pull_request'
        run: |
          # åœ¨ PR åˆ†æ”¯è¿è¡Œ
          cargo bench --bench $bench -- --save-baseline pr
          
          # åˆ‡æ¢åˆ° main è·å–åŸºçº¿
          git checkout main
          cargo bench --bench $bench -- --save-baseline main || true
          
          # åˆ‡æ¢å› PR
          git checkout ${{ github.head_ref }}
          
          # å¯¹æ¯”
          cargo bench --bench $bench -- --baseline main --threshold 0.05
      
      - name: Run benchmarks (main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cargo bench --bench $bench -- --save-baseline main
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            // ç”Ÿæˆå¹¶å‘å¸ƒåŸºå‡†æµ‹è¯•æŠ¥å‘Š
```

---

## æ€»ç»“

### Benchmark è¿è¡Œæ—¶æœºæ€»ç»“

| æ—¶æœº | æ¨èåº¦ | è¡Œä¸šé‡‡ç”¨ | ä½ çš„é¡¹ç›® |
|------|--------|---------|---------|
| **PR æ—¶** | â­â­â­â­â­ | 95% | âš ï¸ éœ€è¦æ·»åŠ  |
| **å‘å¸ƒå‰** | â­â­â­â­â­ | 100% | âœ… å·²å®ç° |
| **å®šæ—¶è¿è¡Œ** | â­â­â­â­ | 80% | âœ… å·²å®ç° |
| **å…³é”®å˜æ›´** | â­â­â­ | 60% | âœ… å·²å®ç° |
| **æ¯æ¬¡æäº¤** | â­ | 10% | âŒ ä¸æ¨è |

### å…³é”®å»ºè®®

1. **ç«‹å³æ”¹è¿›**: åœ¨ PR æ—¶è¿è¡ŒåŸºå‡†æµ‹è¯•å¹¶å¯¹æ¯”
2. **é•¿æœŸä¼˜åŒ–**: ä½¿ç”¨ `cargo-criterion` è·å¾—æ›´å¥½çš„æŠ¥å‘Š
3. **è‡ªåŠ¨åŒ–**: PR ä¸­è‡ªåŠ¨è¯„è®ºåŸºå‡†æµ‹è¯•ç»“æœ
4. **é˜ˆå€¼**: è®¾ç½® 5% çš„æ€§èƒ½å›å½’é˜ˆå€¼

---

## å‚è€ƒèµ„æº

- [Criterion.rs æ–‡æ¡£](https://bheisler.github.io/criterion.rs/book/)
- [cargo-criterion](https://github.com/bheisler/cargo-criterion)
- [GitHub Actions æœ€ä½³å®è·µ](https://docs.github.com/en/actions/learn-github-actions/best-practices)
- [Rust æ€§èƒ½æµ‹è¯•æŒ‡å—](https://nnethercote.github.io/perf-book/benchmarking.html)

---

*æœ€åæ›´æ–°: 2025-11-04*

