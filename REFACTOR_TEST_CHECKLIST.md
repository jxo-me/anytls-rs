# Stream 架构重构测试检查清单

## 📅 重构开始时间
- **开始时间**: 2025-11-03
- **分支**: refactor/stream-reader-writer
- **备份标签**: backup-before-refactor

---

## ✅ 阶段1：准备工作

- [x] Git 备份标签已创建
- [x] 重构分支已创建
- [x] 测试检查清单已创建
- [ ] 性能基准线已建立
- [ ] 代码审查模板已准备

---

## 🔧 阶段2：StreamReader 单元测试

### 基本功能测试
- [ ] `test_stream_reader_basic` - 基本读取
- [ ] `test_stream_reader_buffering` - 缓冲机制
- [ ] `test_stream_reader_eof` - EOF 处理
- [ ] `test_stream_reader_multiple_chunks` - 多数据块

### 边界情况测试
- [ ] 空数据测试
- [ ] 大数据块测试（> 8KB）
- [ ] 连续小数据块测试
- [ ] Channel 关闭时的处理

---

## ♻️ 阶段3：Stream 单元测试

### 写入测试
- [ ] `test_stream_write` - 基本写入
- [ ] 并发写入测试
- [ ] 写入到已关闭 Stream

### 读取测试
- [ ] `test_stream_read` - 基本读取
- [ ] 并发读取测试
- [ ] 从已关闭 Stream 读取

### 读写集成测试
- [ ] 同时读写测试
- [ ] 大数据量传输测试

---

## 🔄 阶段4：Session 单元测试

### Stream 创建测试
- [ ] 客户端创建 Stream
- [ ] 服务端接收 Stream
- [ ] 多个 Stream 创建
- [ ] Stream ID 分配正确性

### 数据传输测试
- [ ] handle_frame 推送数据到 StreamReader
- [ ] 多个 Stream 独立传输
- [ ] Stream 关闭清理

---

## 🛠️ 阶段5：Handler 集成测试

### 代理转发测试
- [ ] 单个流代理功能
- [ ] 数据完整性验证
- [ ] 错误处理测试

### 并发测试
- [ ] 2个并发流
- [ ] 5个并发流
- [ ] 10个并发流
- [ ] 无锁竞争验证

---

## 📡 阶段6：客户端集成测试

### SOCKS5 功能测试
- [ ] SOCKS5 握手
- [ ] 单个请求
- [ ] 多个连续请求
- [ ] 并发请求

### 稳定性测试
- [ ] 10次连续请求全部成功
- [ ] 长时间运行（5分钟）
- [ ] 资源清理验证

---

## ✅ 阶段7：全面测试

### 单元测试
```bash
cargo test --lib
```
- [ ] 所有单元测试通过
- [ ] 无警告信息
- [ ] 测试覆盖率 ≥ 80%

### 集成测试
```bash
cargo test --tests
```
- [ ] basic_proxy 测试通过
- [ ] concurrent 测试通过
- [ ] error_handling 测试通过

### 端到端测试
```bash
# 服务器
cargo run --release --bin anytls-server -- -l 127.0.0.1:8443 -p test_password

# 客户端
cargo run --release --bin anytls-client -- -l 127.0.0.1:1080 -s 127.0.0.1:8443 -p test_password

# 测试
for i in {1..10}; do curl --socks5-hostname 127.0.0.1:1080 http://httpbin.org/get; done
```
- [ ] 第1次请求成功
- [ ] 第2次请求成功
- [ ] 第3-10次请求全部成功
- [ ] 无阻塞或超时
- [ ] 服务器日志无错误
- [ ] 客户端日志无错误

### 性能测试
```bash
cargo bench --bench session_bench
```

**基准指标（重构前）：**
- 吞吐量: _______ MB/s
- 延迟 P50: _______ ms
- 延迟 P99: _______ ms
- CPU 使用: _______ %

**重构后指标：**
- 吞吐量: _______ MB/s （目标: +40-60%）
- 延迟 P50: _______ ms （目标: -50%）
- 延迟 P99: _______ ms （目标: -30-40%）
- CPU 使用: _______ % （目标: -20-30%）

- [ ] 吞吐量提升 ≥ 40%
- [ ] 延迟 P99 降低 ≥ 30%
- [ ] CPU 使用率降低
- [ ] 无内存泄漏

### 压力测试
```bash
# 并发100个连接
for i in {1..100}; do
  curl --socks5-hostname 127.0.0.1:1080 http://httpbin.org/delay/1 &
done
wait
```
- [ ] 100个并发连接全部成功
- [ ] 无连接超时
- [ ] 无 panic 或崩溃
- [ ] 资源正常释放

---

## 🧹 阶段8：清理验证

### 代码质量
```bash
cargo clippy -- -W clippy::all
```
- [ ] 无 clippy 警告
- [ ] 无 unused imports
- [ ] 无 dead code

### 文档完整性
- [ ] README.md 已更新
- [ ] 性能对比数据已添加
- [ ] API 文档已更新
- [ ] 示例代码已验证

### Git 清理
- [ ] 无调试代码
- [ ] 提交信息清晰
- [ ] 已合并到 main（如果通过）

---

## 🚨 失败回滚检查清单

如果任何阶段失败：

1. **记录失败信息**
   - [ ] 失败的测试用例
   - [ ] 错误日志
   - [ ] 性能数据（如果有）

2. **评估是否继续**
   - [ ] 问题是否可以快速修复
   - [ ] 是否需要调整设计
   - [ ] 是否需要回滚

3. **回滚步骤**
   ```bash
   git checkout master
   git branch -D refactor/stream-reader-writer
   ```
   - [ ] 回滚完成
   - [ ] 问题分析完成
   - [ ] 重新评估方案

---

## 📊 最终验收标准

### 必须满足（硬性要求）
- [ ] ✅ 所有单元测试通过
- [ ] ✅ 所有集成测试通过
- [ ] ✅ 端到端测试连续10次成功
- [ ] ✅ 无回归 bug
- [ ] ✅ 性能提升达标（+40% 吞吐量）

### 期望满足（软性目标）
- [ ] 🎯 延迟降低 ≥ 30%
- [ ] 🎯 CPU 使用率降低
- [ ] 🎯 代码覆盖率 ≥ 80%
- [ ] 🎯 文档完整

### 可选优化（锦上添花）
- [ ] 💎 内存占用降低
- [ ] 💎 更详细的性能分析
- [ ] 💎 额外的示例代码
- [ ] 💎 性能调优文档

---

## 📝 测试日志

### 阶段2完成时间: __________
### 阶段3完成时间: __________
### 阶段4完成时间: __________
### 阶段5完成时间: __________
### 阶段6完成时间: __________
### 阶段7完成时间: __________
### 阶段8完成时间: __________

### 总耗时: __________ 天

---

## 🎉 完成标志

当所有必须满足的标准都达成时，重构完成！

- [ ] 🏆 **重构成功**
- [ ] 📦 已合并到 main 分支
- [ ] 🚀 已部署到生产环境（如适用）

---

*最后更新: 2025-11-03*

